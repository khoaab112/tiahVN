(function() {
    'use strict';
    const itemAppTest = {
        "発注点": {
            "type": "NUMBER",
            "value": ""
        },
        "倉庫エリアコード": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "商品区分": {
            "type": "CHECK_BOX",
            "value": []
        },
        "金額": {
            "type": "NUMBER",
            "value": "0"
        },
        "発単": {
            "type": "NUMBER",
            "value": ""
        },
        "出荷済数量": {
            "type": "NUMBER",
            "value": "1"
        },
        "受注No2": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "部門コード": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "出荷指示数": {
            "type": "NUMBER",
            "value": ""
        },
        "引当済": {
            "type": "NUMBER",
            "value": ""
        },
        "倉庫エリアマスタレコード番号": {
            "type": "NUMBER",
            "value": ""
        },
        "消費税額": {
            "type": "CALC",
            "value": "0"
        },
        "有効在庫数": {
            "type": "NUMBER",
            "value": ""
        },
        "入数": {
            "type": "NUMBER",
            "value": "3"
        },
        "利益率": {
            "type": "CALC",
            "value": ""
        },
        "納入先名称_直送先コード": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "得意先コード": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "郵便番号": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "親品_子品チェック": {
            "type": "CHECK_BOX",
            "value": [
                "親品"
            ]
        },
        "自社倉庫コード": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "受注No_PCA": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "取込日": {
            "type": "DATE",
            "value": "2023-07-26"
        },
        "住所2": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "住所1": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "税率": {
            "type": "NUMBER",
            "value": ""
        },
        "セット品チェック": {
            "type": "CHECK_BOX",
            "value": []
        },
        "納期": {
            "type": "DATE",
            "value": "2023-07-27"
        },
        "作成日時": {
            "type": "CREATED_TIME",
            "value": "2023-07-26T07:26:00Z"
        },
        "原価金額": {
            "type": "CALC",
            "value": "0"
        },
        "納入先名称": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "$id": {
            "type": "__ID__",
            "value": "31"
        },
        "支店名": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "単価": {
            "type": "NUMBER",
            "value": ""
        },
        "更新者": {
            "type": "MODIFIER",
            "value": {
                "code": "Administrator",
                "name": "Administrator"
            }
        },
        "粗利益": {
            "type": "CALC",
            "value": "0"
        },
        "部門名": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "先方商品コード": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "発注数": {
            "type": "NUMBER",
            "value": ""
        },
        "税区分": {
            "type": "NUMBER",
            "value": "2"
        },
        "箱数": {
            "type": "CALC",
            "value": "0"
        },
        "会社FAX": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "受注数": {
            "type": "NUMBER",
            "value": "6"
        },
        "処理ステータス": {
            "type": "DROP_DOWN",
            "value": "在庫チェック済"
        },
        "会社TEL": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "受注日": {
            "type": "DATE",
            "value": "2023-07-26"
        },
        "発注単位": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "支店コード": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "受注明細番号_mimosa": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "品名": {
            "type": "SINGLE_LINE_TEXT",
            "value": "テスト 1"
        },
        "廃番ステータス": {
            "type": "CHECK_BOX",
            "value": []
        },
        "作成者": {
            "type": "CREATOR",
            "value": {
                "code": "Administrator",
                "name": "Administrator"
            }
        },
        "$revision": {
            "type": "__REVISION__",
            "value": "47"
        },
        "原単価": {
            "type": "NUMBER",
            "value": "0"
        },
        "受注No_mimosa": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "登録区分": {
            "type": "RADIO_BUTTON",
            "value": "取込"
        },
        "更新日時": {
            "type": "UPDATED_TIME",
            "value": "2023-08-08T04:12:00Z"
        },
        "商品コード_JANコード": {
            "type": "SINGLE_LINE_TEXT",
            "value": "C0002"
        },
        "受バラ": {
            "type": "NUMBER",
            "value": ""
        },
        "納品日": {
            "type": "DATE",
            "value": "2023-07-27"
        },
        "作成者１": {
            "type": "USER_SELECT",
            "value": [{
                "code": "Administrator",
                "name": "Administrator"
            }]
        },
        "ID_Mimosa": {
            "type": "NUMBER",
            "value": "1260339"
        },
        "出荷種別": {
            "type": "DROP_DOWN",
            "value": "10"
        },
        "ID_PCA": {
            "type": "NUMBER",
            "value": ""
        },
        "得意先名": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        },
        "標準価格": {
            "type": "NUMBER",
            "value": ""
        },
        "セット品区分": {
            "type": "RADIO_BUTTON",
            "value": "単品"
        },
        "単位": {
            "type": "SINGLE_LINE_TEXT",
            "value": ""
        }
    };

    kintone.events.on('app.record.index.show', function(event) {
        const data = event.records[0];
        const inventoryMimosa = document.getElementById('btn-inventory-mimosa');
        inventoryMimosa.onclick = async function() {
            //lấy kết quả khi GET các recoreds của app => 親品
            const resultGetRecords = await fetchBatchRecords();
            //test push
            resultGetRecords.push(itemAppTest)
                //mã sp codeProducts
            const codeProducts = [];
            for (let value of resultGetRecords) {
                codeProducts.push(value.商品コード_JANコード.value);
            };
            //test
            codeProducts.push('C0002');
            //get token
            const token = await getVerificationCode();
            // lấy dang sách sản phẩm đang có trong kho
            const getStockByMaterials = await getStockByMaterial(codeProducts, token);

            //Merge data của mimosa
            const resultTemp = {};
            getStockByMaterials.data.forEach(item => {

                const material_cd = item.stock.material_cd;
                const ursv_qty = item.stock.ursv_qty;

                if (!resultTemp[material_cd]) {
                    resultTemp[material_cd] = Number(ursv_qty);
                } else {
                    resultTemp[material_cd] += Number(ursv_qty);
                }
            });

            const resultMerge = Object.entries(resultTemp).map(([material_cd, inventory]) => {
                return {
                    'material_cd': material_cd,
                    'inventory': inventory
                };
            });
            // Merge data của app với những mã sản phẩm trùng
            const arrTempApp = {};
            resultGetRecords.forEach(item => {

                const material_cd = item.商品コード_JANコード.value;
                const ursv_qty = item.受注数.value;

                if (!arrTempApp[material_cd]) {
                    arrTempApp[material_cd] = Number(ursv_qty);
                } else {
                    arrTempApp[material_cd] += Number(ursv_qty);
                }
            });

            const resultMergeApp = Object.entries(arrTempApp).map(([material_cd, inventory]) => {
                return {
                    'material_cd': material_cd,
                    'inventory': inventory
                };
            });
            // 2 mảng đẻ đem so sánh arrAPP = resultMergeApp // arrMimosa  = resultMerge

            // so sánh / lọc điều kiện
            var keepRunning = true;
            resultMergeApp.forEach(itemApp => {
                const matchingItem = resultMerge.find(itemMimosa => itemMimosa.material_cd === itemApp.material_cd);
                // if (!matchingItem) {
                //     return event;
                // }
                //testing
                if (!matchingItem) {
                    // keepRunning = false
                    return;
                }
                if (matchingItem.inventory > itemApp.inventory) {
                    // keepRunning = false
                    return event;
                }
            });
            if (!keepRunning) return event;
            // thỏa mãn hết thì đầy sang app 193
            //map với data vào app 
            var records = [];
            for (let value of resultGetRecords) {
                let record = {
                    "商品コード": {
                        "type": "SINGLE_LINE_TEXT",
                        "value": value.先方商品コード.value
                    },
                    "単位": {
                        "type": "SINGLE_LINE_TEXT",
                        "value": value.単位.value
                    },
                    "単価": {
                        "type": "NUMBER",
                        "value": value.単価.value
                    },
                    "倉庫コード": {
                        "type": "SINGLE_LINE_TEXT",
                        "value": value.自社倉庫コード.value
                    },
                    "商品区分": {
                        "type": "CHECK_BOX",
                        "value": value.商品区分.value[0] ? [value.商品区分.value[0]] : []
                    },
                    "ID_PCA": {
                        "type": "NUMBER",
                        "value": value.ID_PCA.value
                    }
                };
                records.push(record);
            };

            const resultPostApp183 = await postRecordsInBatches(records);
            console.log(resultPostApp183);


        }
        return event;
    });




    //get stock by material_cd tra cứu sản phầm theo mã sản phẩm
    // đầu và là một mảng và token 
    async function getStockByMaterial(material_cd, token) {
        const material = material_cd;
        const limit = 5000;
        const offset = 0;
        const method = 'GET';
        var lengthMaterial = material.length
        var path = '/jwt/v2/stock/find?';
        material.forEach((value, index) => {
            path += "material_cd[]=" + value
            if (index < (lengthMaterial - 1)) {
                path += "&";
            }
        });
        var headers = {
            'Authorization': 'Bearer ' + token.token,
            'X-UNITID': token.units.id,
            'Content-Type': 'application/json',
        };
        var domain = 'https://mimosa-stg.dialog-wms.com' + path + '&limit=' + limit + '&offset=' + offset;
        var body = '';

        return kintone.proxy(domain, method, headers, body)
            .then(function(response) { // [b, status, h]
                var responseBody = JSON.parse(response[0]);
                return responseBody;
            })
            .catch(function(error) {
                console.log(error);
                return error;
            });
    };


    // Hàm để lấy một lô bản ghi
    function fetchBatchRecords() {
        return new Promise(function(resolve, reject) {
            var batchSize = 500; // Kích thước mỗi lô (số bản ghi trong mỗi lần yêu cầu)
            var offset = 0; // Bắt đầu từ bản ghi đầu tiên
            var allRecords = [];

            function fetchRecords() {
                var bodyQuery = {
                    'app': '189',
                    'query': '親品_子品チェック in ("親品")',
                    'totalCount': true,
                    'offset': offset,
                    'limit': batchSize
                };
                kintone.api(kintone.api.url('/k/v1/records', true), 'GET', bodyQuery, function(response) {
                    var records = response.records;
                    allRecords = allRecords.concat(records); // Kết hợp bản ghi vào mảng tổng

                    var totalCount = response.totalCount;
                    offset += batchSize; // Cập nhật vị trí bắt đầu cho lần yêu cầu tiếp theo

                    if (offset < totalCount) {
                        // Tiếp tục lấy các lô bản ghi cho đến khi đạt đủ số lượng bản ghi
                        fetchRecords();
                    } else {
                        resolve(allRecords);
                    }
                }, function(error) {
                    reject(error);
                });
            }

            fetchRecords();
        });
    }


    // const token = await getVerificationCode();


    // hàm lấy token
    async function getTokenMimosa() {
        var body = JSON.stringify({
            'name': 'globalb',
            'password': 's8LQmvyM',
        });
        var pathLogin = 'https://mimosa-stg.dialog-wms.com/jwt/v2/login';
        var header = {
            'Content-Type': 'application/json',
        };

        try {
            const response = await kintone.proxy(pathLogin, "POST", header, body);
            var responseBody = JSON.parse(response[0]);
            return responseBody;
        } catch (error) {
            console.log(error);
            return error;
        }
    };

    // parameter data = kết quả trả về của thằng login
    async function setStorage(data) {
        var localStorageMimosa = {
            'token_type': data.data.token_type,
            'token': data.data.token,
            'units': {
                'id': data.data.units[0].id,
                'nm': data.data.units[0].nm,
            },
            'expires_in': data.data.expires_in,
            'created_at': await formatDateTime(),
        };
        localStorage.setItem("localStorageMimosa", JSON.stringify(localStorageMimosa));
    };

    function formatDateTime() {
        var currentDate = new Date();
        var year = currentDate.getFullYear();
        var month = String(currentDate.getMonth() + 1).padStart(2, '0');
        var day = String(currentDate.getDate()).padStart(2, '0');
        var hours = String(currentDate.getHours()).padStart(2, '0');
        var minutes = String(currentDate.getMinutes()).padStart(2, '0');
        var seconds = String(currentDate.getSeconds()).padStart(2, '0');

        var formattedDateTime = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        return formattedDateTime;
    };

    function compareTime(startTime, TimeBySeconds) {
        startTime = new Date(startTime);
        var timeEnd = new Date(startTime.getTime() + TimeBySeconds * 1000);
        var timeNow = new Date();
        return (timeEnd - timeNow) <= 0 ? false : true;
    };

    function clearStorage() {
        window.localStorage.removeItem('localStorageMimosa')
    };

    function getStorage() {
        const localStorageMimosa = JSON.parse(localStorage.getItem("localStorageMimosa"));
        return localStorageMimosa;
    };

    async function getVerificationCode() {

        var token = await getStorage();
        if (!token) {
            clearStorage();
            await setStorage(await getTokenMimosa());
            token = await getStorage();
        }
        var timeToken = token.created_at;
        var timeExpiry = token.expires_in;
        if (!compareTime(timeToken, timeExpiry)) {
            clearStorage();
            await setStorage(await getTokenMimosa());
            token = await getStorage();
        }
        return token;
    };
    //end token

    async function postRecordsInBatches(records) {
        const batchSize = 100; // Kích thước mỗi lô (số bản ghi trong mỗi lần yêu cầu)
        const totalRecords = records.length;
        let offset = 0;

        while (offset < totalRecords) {
            const batchRecords = records.slice(offset, offset + batchSize);

            const bodyPut = {
                'app': '183',
                'records': batchRecords // array 
            };

            await kintone.api(kintone.api.url('/k/v1/records', true), 'POST', bodyPut);

            offset += batchSize;
        }
    }
})();